---
title : "First analysis"
---

```{r setup, include=FALSE}
source("function.R")
```

# Simple forest simulation without control

```{r}
T = 200
forest1 <- cbind(forest_simul(T = T, x1 = 100, x2 = 300, u = c(rep(0, T/5), rep(0, T/5))), simul = 1)
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 300, x2 = 100, u = c(rep(0, T/5), rep(0, T/5))), simul = 2))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 200, x2 = 200, u = c(rep(0, T/5), rep(0, T/5))), simul = 3))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 400, x2 = 200, u = c(rep(0, T/5), rep(0, T/5))), simul = 4))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 200, x2 = 400, u = c(rep(0, T/5), rep(0, T/5))), simul = 5))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 400, x2 = 400, u = c(rep(0, T/5), rep(0, T/5))), simul = 6))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 20, x2 = 50, u = c(rep(0, T/5), rep(0, T/5))), simul = 7))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 50, x2 = 300, u = c(rep(0, T/5), rep(0, T/5))), simul = 8))
forest1 <- rbind(forest1, cbind(forest_simul(T = T, x1 = 10, x2 = 10, u = c(rep(0, T/5), rep(0, T/5))), simul = 9))
# plot
ggplot(forest1, aes(x = t)) +
    geom_line(aes(y = x1, color = factor(simul)), linetype = "dashed") +
    geom_line(aes(y = x2, color = factor(simul))) +
    labs(x = "Time", y = "Population", title = "Population dynamics") +
    theme_bw() +
    facet_wrap(~simul)
```

```{r}
ggplot(forest1, aes(x = t, y = H)) +
    geom_line(color = "red") +
    labs(x = "Time", y = "Shannon index", title = "Shannon index") +
    theme_bw() +
ggplot(forest1, aes(x = t, y = Biomasse)) +
    geom_line(color = "black") +
    labs(x = "Time", y = "Biomass", title = "Biomass") +
    theme_bw() +
ggplot(forest1 %>% filter(t%%5 == 2), aes(x = t, y = Prod)) +
    geom_point(color = "black") +
    labs(x = "Time", y = "Harvesting", title = "Harvesting") +
    theme_bw()
```

# OPTIMAL CONTROL FOR DIFFERENT OBJECTIVES

```{r}
T = 100; x1 = 400; x2 = 200
Opti_by_obj = data.frame()
Opti_by_obj <- rbind(Opti_by_obj,
    cbind(Optim_forest("Prod", T, x1, x2), obj = "Prod"),
    cbind(Optim_forest("Biomasse", T, x1, x2), obj = "Biomasse"),
    cbind(Optim_forest("H", T, x1, x2), obj = "H")
)

ggplot(Opti_by_obj, aes(x = t, y = Biomasse, color = factor(obj))) +
    geom_line(show.legend = FALSE) +
    labs(x = "Time", y = "Biomasse", title = "Biomasse") +
    theme_bw() +
ggplot(Opti_by_obj, aes(x = t, y = H, color = factor(obj))) +
    geom_line(show.legend = FALSE) +
    labs(x = "Time", y = "Shannon Index", title = "Shannon Index") +
    theme_bw() +
ggplot(Opti_by_obj %>% filter(t%%5 == 2), aes(x = t, y = Prod, color = factor(obj))) +
    geom_point() +
    labs(x = "Time", y = "Productivity", title = "Productivity") +
    theme_bw() +
    geom_point(data = Opti_by_obj %>% group_by(obj) %>% summarise(Prod = sum(Prod)), aes(x = 50, y = Prod, color = factor(obj)), size = 3, shape = 4)
```

```{r}
# plot forest evolution for each objective
ggplot(Opti_by_obj, aes(x = t)) +
    geom_line(aes(y = x1), color = "darkgreen") +
    geom_line(aes(y = x2), color = "lightblue") +
    labs(x = "Time", y = "Population", title = "Population dynamics") +
    theme_bw() +
    facet_wrap(~obj)
```

# OPTIMAL CONTROL (1 min) FOR DIFFERENT INITIAL CONDITIONS

x1 = seq(0, 500, 100)
x2 = seq(0, 500, 100)
EI = expand.grid(x1,x2)
T = 200

Opti_by_EI = data.frame()
for(i in 1:nrow(EI)){
    Opti_by_EI <- rbind(
        Opti_by_EI,
        cbind(Optim_forest("Prod",T, EI[i,1], EI[i,2]), obj = "Prod", x10 = as.character(EI[i,1]), x20 = as.character(EI[i,2])),
        cbind(Optim_forest("Biomasse",T, EI[i,1], EI[i,2]), obj = "Biomasse", x10 = as.character(EI[i,1]), x20 = as.character(EI[i,2])),
        cbind(Optim_forest("H", T, EI[i,1], EI[i,2]), obj = "H", x10 = as.character(EI[i,1]), x20 = as.character(EI[i,2]))
    )
}

# save 

# short with mean H
Opti_by_EI_short <- Opti_by_EI %>% group_by(x10, x20) %>% 
    summarise(H = mean(H), Biomasse = mean(Biomasse), Prod = mean(Prod))

# plot
ggplot(Opti_by_EI, aes(x = t, y = Biomasse, color = paste(x10,x20))) +
    geom_line() +
    labs(x = "Time", y = "Biomasse", title = "Biomasse") +
    theme_bw() +
    facet_wrap(~obj)
ggplot(Opti_by_EI, aes(x = t, y = H, color = paste(x10,x20))) +
    geom_line() +
    labs(x = "Time", y = "Shannon Index", title = "Shannon Index") +
    theme_bw() +
    facet_wrap(~obj)
ggplot(Opti_by_EI %>% filter(t%%5 == 2), aes(x = t, y = Prod, color = paste(x10,x20))) +
    geom_point() +
    #geom_line(size = 0.2) +
    labs(x = "Time", y = "Productivity", title = "Productivity") +
    theme_bw() +
    facet_wrap(~obj) +
    geom_point(data = Opti_by_EI %>% group_by(obj, x10, x20) %>% summarise(Prod = sum(Prod)/3), aes(x = 50, y = Prod, color = paste(x10,x20)), size = 3, shape = 4)
ggplot(Opti_by_EI_short, aes(x = x10, y = x20, fill = H)) +
    geom_tile() +
    scale_fill_gradient() +
    labs(x = "x1", y = "x2", title = "Hitmap of mean(H)") +
    theme_bw()
ggplot(Opti_by_EI_short, aes(x = x10, y = x20, fill = Prod)) +
    geom_tile() +
    scale_fill_gradient() +
    labs(x = "x1", y = "x2", title = "Hitmap of mean(Prod)") +
    theme_bw()
ggplot(Opti_by_EI_short, aes(x = x10, y = x20, fill = Biomasse)) +
    geom_tile() +
    scale_fill_gradient() +
    labs(x = "x1", y = "x2", title = "Hitmap of mean(Biomasse)") +
    theme_bw()

# EQUILIBRIUM ~ u1, u2

```{r}
# solution without control
sol(0,0)

# solution with different control
u1 = seq(0,0.15,0.01)
u2 = seq(0,0.15,0.01)
hm = expand.grid(u1,u2)
colnames(hm) <- c("u1", "u2")
for (i in 1:nrow(hm)){
    hm$x1[i] = sol(hm$u1[i],hm$u2[i])[1]
    hm$x2[i] = sol(hm$u1[i],hm$u2[i])[2]
}
# plot
ggplot(hm, aes(x = u1, y = u2, fill = x1)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "u1", y = "u2", title = "Hitmap of equilibrium for x1") +
    theme_bw()+
ggplot(hm, aes(x = u1, y = u2, fill = x2)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "u1", y = "u2", title = "Hitmap of equilibrium for x2") +
    theme_bw()
```

# Obj in state space : H, Prod, Biomasse ~ x1, x20

```{r}
x1 = seq(0, 500, 10)
x2 = seq(0, 500, 10)
EI = expand.grid(x1,x2)
colnames(EI) <- c("x1", "x2")
EI$H = f_H(EI[,1],EI[,2])
# Replace NA by 0
EI$H[is.na(EI$H)] <- 0
EI$Biomasse = f_Biomasse(EI[,1],EI[,2])
EI$Prod = f_Prod(EI[,1],EI[,2])

ggplot(EI, aes(x = x1, y = x2, fill = Biomasse)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "x1", y = "x2", title = "Hitmap of Biomass") +
    theme_bw()
ggplot(EI, aes(x = x1, y = x2, fill = H)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "x1", y = "x2", title = "Hitmap of H") +
    theme_bw()
ggplot(EI, aes(x = x1, y = x2, fill = Prod)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "x1", y = "x2", title = "Hitmap of Prod") +
    theme_bw()

ggplot(EI %>% filter(H > 0.95, Biomasse > 600), aes(x = x1, y = x2, fill = H)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "x1", y = "x2", title = "Hitmap of H") +
    theme_bw()
```

# TRAJECTORY OF AN OPTIMAL CONTROL 

T = 400
forest2 <- Optim_forest("Prod", T = T, x1 = 200, x2 = 200)
saveRDS(forest2, "forest_Prod")

forest2 <- Optim_forest("H", T = T, x1 = 200, x2 = 200)
saveRDS(forest2, "forest_H")

forest2 <- Optim_forest("Biomasse", T = T, x1 = 200, x2 = 200)
saveRDS(forest2, "forest_Biomasse")

```{r}
T = 400
forest_Prod <- readRDS("forest_Prod")
forest_H <- readRDS("forest_H")
#forest_Biomasse <- readRDS("forest_Biomasse")

ggplot(forest_Prod %>% filter(t > 0 & t < 400), aes(x = t)) +
    geom_line(aes(y = x1), color = "darkgreen") +
    geom_line(aes(y = x2), color = "lightblue") +
    labs(x = "Time", y = "Population", title = "Population dynamics") +
    theme_bw()
# plot
ggplot(forest_Prod %>% filter(t > 50 & t < 200), aes(x = x1, y = x2, color = t)) +
    geom_path() +
    geom_point() +
    labs(x = "x1", y = "x2", title = "Trajectory of the forest") +
    theme_bw()

ggplot(forest_Prod  %>% filter(t > 50 & t < 200), aes(x = u1, y = u2, color = t)) +
    geom_path() +
    geom_point() +
    labs(x = "u1", y = "u2", title = "Trajectory of the control") +
    theme_bw()

ggplot(forest_Prod %>% filter(t > 0 & t < 400), aes(x = t, y = u2)) +
    geom_line() +
    geom_point() +
    labs(x = "u2", y = "t", title = "Trajectory of the control") +
    theme_bw()
```

## Trajectory of a suboptimal control

```{r}
forest3 <- forest_simul(T = 1000, x1 = 200, x2 = 200, u = rep(0.1, 2*1000/5))
# trajectoire dans l'espace x1, x2
ggplot(forest3, aes(x = x1, y = x2)) +
    geom_path() +
    geom_point() +
    labs(x = "x1", y = "x2", title = "Trajectory of the forest") +
    theme_bw()
```

# VIABILITY Kernel
    
```{r}
x1 = seq(100, 500, 10)
x2 = seq(100, 500, 10)
u = seq(0,0.5,0.1)
table = expand.grid(x1,x2,u,u)
colnames(table) <- c("x1", "x2", "u1", "u2")
table$H = f_H(table$x1,table$x2)
# replavce NAn by 0
table$H[is.na(table$H)] <- 0
table$Biomasse_new = f_Biomasse(table$x1,table$x2)

# create the new state of x1 and x2 after 1 time step for each control

for (i in 1:nrow(table)){
    table$x1_new[i] = x1_new(table$x1[i],table$x2[i],table$u1[i])
    table$x2_new[i] = x2_new(table$x1[i],table$x2[i],table$u2[i])
}

table$H_new = f_H(table$x1_new,table$x2_new)
# replavce NAn by 0
table$H_new[is.na(table$H_new)] <- 0
table$Biomasse_new = f_Biomasse(table$x1_new,table$x2_new)

# Add viability for state x1 and x2 in column Viable as 1 and 0
# Viable = 1 if B > 300 and H > 0.95
# Viable = 0 if B < 300 or H < 0.95
for (i in 1:nrow(table)){
    table$Viable = ifelse(table$Biomasse > 600 & table$H > 0.9995, 1, 0)
}

# Viability
K_viab <- table %>% group_by(x1,x2) %>% summarize(Viable = max(Viable))

# Plot of Constraint Kernel
ggplot(K_viab, aes(x = x1, y = x2, color = factor(Viable))) +
    geom_point() +
    labs(x = "x1", y = "x2", title = "Viability kernel") +
    theme_bw()

# Find the nearest neighbors of each new state (from table) in the viability kernel (K_viab)
# Add the viability of the nearest neighbors in the table

for (z in 1:20){
    for (i in 1:nrow(table)){
        table$Viable_nn[i] = ifelse(table$Viable[i] == 0, 0, K_viab$Viable[which.min((K_viab$x1 - table$x1_new[i])^2 + (K_viab$x2 - table$x2_new[i])^2)])
    }
    K_viab <- table %>% group_by(x1,x2) %>% summarize(Viable = max(Viable_nn))
}

# Add a column in table with K_viable result for each state

table <- merge(table %>% select(-Viable), K_viab, by = c("x1", "x2"))

# Plot of Viability Kernel
ggplot(K_viab, aes(x = x1, y = x2, color = factor(Viable))) +
    geom_point() +
    labs(x = "x1", y = "x2", title = "Viability kernel") +
    theme_bw()

# Note de résultat
# u1 est toujours nul
# donc je pourrais tracer la productivité dans l'espace x1, x2, u2

# avec table tracer tous les segments (x1,x2) (x1_new, x2_new)
#ggplot(table, aes(x = x1, y = x2)) +
#    #geom_point(aes(x = x1_new, y = x2_new, color = factor(Viable))) +
#    # arrows
#    geom_segment(aes(xend = x1_new, yend = x2_new), arrow = arrow(length = unit(0.1,"cm"))) +
#    labs(x = "x1", y = "x2", title = "Viability kernel") +
#    theme_bw() +
#    facet_grid(u1 ~ u2)

# J'aimerai visualiser les trajectoires des points Viable de la table dans l'espace x1, x2
# Avce les differents control
```
    
```{r}
ggplot(table %>% filter(Viable == 1), aes(x = x1, y = x2)) +
    geom_segment(aes(xend = x1_new, yend = x2_new, color = factor(Viable_nn)), arrow = arrow(length = unit(0.1,"cm"))) +
    #geom_point() +
    labs(x = "x1", y = "x2", title = "Trajectory of the forest") +
    theme_bw() +
    facet_grid(u1 ~ u2)
```

# Graphe de la matrice de transition

```{r}
# create the new state of x1 and x2 after 1 time step for each control
get_point_on_segment <- function(x1, x2, x1_new, x2_new, alpha) {
    # Calcul de la direction
    direction_x <- x1_new - x1
    direction_y <- x2_new - x2
    longueur <- sqrt(direction_x^2 + direction_y^2)
    # Calcul des coordonnées du nouveau point
    beta = alpha/longueur
    new_x <- x1 + beta * direction_x
    new_y <- x2 + beta * direction_y

  return(c(new_x, new_y))
}

nn <- function(x1_new, x2_new){
    return(table[which.min((table$x1 - x1_new)^2 + (table$x2 - x2_new)^2),c("x1","x2")] %>% as.numeric())
}
```

```{r}
f = 5
x1 = seq(0, 500, f)
x2 = seq(0, 500, f)
fc = 0.2
u2 = seq(0,1,fc)
table = expand.grid(x1,x2,u2)
colnames(table) <- c("x1", "x2", "u2")

table$x1_new <- apply(table, 1, function(row) {
  result <- forest_5(row["x1"], row["x2"], 0, row["u2"])
  return(result[1])
})

table$x2_new <- apply(table, 1, function(row) {
  result <- forest_5(row["x1"], row["x2"], 0, row["u2"])
  return(result[2])
})

library(RANN)
nn2(table[,c("x1","x2")], query = table[,c("x1_new","x2_new")], k = 1)$nn.idx -> idx
# arrange table by idx
table <- table %>% cbind(table[idx,c("x1","x2")])
colnames(table) <- c("x1", "x2", "u2","x1_new", "x2_new", "x1_nn", "x2_nn")

table$x1_new_norm <- apply(table, 1, function(row) {
  norm <- get_point_on_segment(row["x1"], row["x2"], row["x1_new"], row["x2_new"], f)
  return(norm[1])
})

table$x2_new_norm <- apply(table, 1, function(row) {
  norm <- get_point_on_segment(row["x1"], row["x2"], row["x1_new"], row["x2_new"], f)
  return(norm[2])
})
```

```{r}
# Faire un graphe avec les segments (x1,x2) (x1_new, x2_new) pour chaque control u1, u2 en fixant le taille des segments à 40
ggplot(table, aes(x = x1, y = x2)) +
    #geom_tile(data = V_df, aes(x = x1, y = x2, fill = factor(Viable)), alpha = 0.3) +
    # color of the point from the viability matrix but not the vector
    scale_color_manual(values = c("red", "green")) +
    geom_segment(aes(xend = x1_new_norm, yend = x2_new_norm), linewidth = 0.3) +#, arrow = arrow(length = unit(0.05,"cm"))) +
    labs(x = "x1", y = "x2", title = "Transition matrix") +
    facet_wrap(~u2) +
    theme_bw()
```

# Create the Transition matrix using the table

```{r}
M = array(0, dim = c(length(x1), length(x2), length(x1), length(x2), length(u2)))

#M[table$x1/f + 1, table$x2/f + 1, table$x1_new/f + 1, table$x2_new/f +1, table$u2/fc +1] = 1

for(i in 1 : nrow(table)){
    M[table[i,1]/f + 1, table[i,2]/f + 1, table[i,6]/f + 1, table[i,7]/f +1, table[i,3]/fc +1] = 1
}
```

# Create the matrix of size x1*x2 containing 1 or 0 if the point is viable or not

## Constraint Kernel (Viability Kernel 0)

```{r}
# V matrice avec x1, x2 comme dimension et rempli par 0 ou 1 si le point est viable ou non
V = array(0, dim = c(length(x1), length(x2)))
for (i in x1){
    for (j in x2){
        H = ifelse(is.na(f_H(i,j)), 0, f_H(i,j))
        V[i/f+1,j/f+1] = ifelse(H > 0.95 & f_Biomasse(i,j) > 550, 1, 0)
    }
}
image(x1,x2,V)
```

# Viability Kernel par iteration, on s'arrete quand V_new = V

```{r}
for(t in 1:50){
    V_new = array(0, dim = c(length(x1), length(x2)))
    for (i in x1){
        for (j in x2){
            if(V[i/f+1,j/f+1] == 0){next}
            for (k in u2){
                if(sum(M[i/f+1,j/f+1,,,k/0.25+1] * V) == 1){
                    V_new[i/f+1,j/f+1] = 1
                    break
                }
            }
        }
    }
    if(all(V == V_new)){print(t);break}
    V = V_new
}

# graph of V as a matrix of color
image(x1,x2,V)
```

# Look at the trajectory of some points

```{r}
X1 = 300
X2 = 260

V_df = as.data.frame(V)
colnames(V_df) <- x1
rownames(V_df) <- x2
# tranform into a x1; x2, viability dataframe
V_df <- reshape2::melt(as.matrix(V_df))
colnames(V_df) <- c("x1", "x2", "Viable")
ggplot() +
    geom_point(data = V_df, aes(x = x1, y = x2, color = factor(Viable)), alpha = 0.5) +
    # color of the point from the viability matrix but not the vector
    scale_color_manual(values = c("red", "green")) +
    geom_segment(data = table %>% filter(x1 %in% X1, x2 %in% X2), aes(x = x1, y = x2,xend = x1_nn, yend = x2_nn), arrow = arrow(length = unit(0.1,"cm"))) +
    labs(x = "x1", y = "x2", title = "Trajectory of the forest") +
    # add matrix V en background as done in image (x1)
    theme_bw()
```

```{r}
time <- Sys.time()
# Matrice de dimension 5
M = array(0, dim = c(length(x1), length(x2), length(x1), length(x2), length(u2)))

M[table$x1, table$x2, table$x1_new, table$x2_new, table$u2]
# Remplir la matrice
for(i in x1){
    for(j in x2){
        for(k in u2){
            NN = table %>% filter(x1 == i, x2 == j, u2 == k) %>% select(x1_nn, x2_nn) %>% as.numeric()
            M[i/f+1,j/f+1,NN[1]/f+1,NN[2]/f+1,k/0.25+1] = 1
        }
    }
    print(i)
}
period = Sys.time() - time
```
  
# plot donnant la trajectoire 5 ans plus tard pour un point (x1,x2) et tous les controls

```{r}
X1 = c(120)#, 540 - f, 540 + f)
X2 = c(180)#, 360 - f, 360 + f)

V_df = as.data.frame(V)
colnames(V_df) <- x1
rownames(V_df) <- x2
# tranform into a x1; x2, viability dataframe
V_df <- reshape2::melt(as.matrix(V_df))
colnames(V_df) <- c("x1", "x2", "Viable")
ggplot() +
    geom_point(data = V_df, aes(x = x1, y = x2, color = factor(Viable)), alpha = 0.5) +
    # color of the point from the viability matrix but not the vector
    scale_color_manual(values = c("red", "green")) +
    geom_segment(data = table %>% filter(x1 %in% X1, x2 %in% X2), aes(x = x1, y = x2,xend = x1_new, yend = x2_new), arrow = arrow(length = unit(0.1,"cm"))) +
    labs(x = "x1", y = "x2", title = "Trajectory of the forest") +
    # add matrix V en background as done in image (x1)
    theme_bw()
```